<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Spatio Property Services</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" />
  <style>
    body { 
      background-color: #f8fafc; 
      overflow-x: hidden;
      padding-top: 70px;
    }
    
    /* Top Navigation */
    .top-nav {
      background: #1e40af;
      color: white;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .nav-brand {
      display: flex;
      align-items: center;
      font-weight: 600;
      font-size: 1.25rem;
    }
    
    .nav-brand i {
      margin-right: 8px;
    }
    
    .nav-link {
      color: #cbd5e1 !important;
      padding: 0.5rem 1rem !important;
      border-radius: 4px;
      transition: all 0.2s;
    }
    
    .nav-link:hover, 
    .nav-link.active {
      background: rgba(255,255,255,0.1) !important;
      color: white !important;
    }
    
    .mobile-menu-btn {
      background: transparent;
      border: none;
      color: white;
      font-size: 1.5rem;
    }
    
    /* Main Content */
    .main-content {
      padding: 1.5rem;
    }
    
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .page-title {
      margin: 0;
      font-size: 1.5rem;
      color: #1e293b;
    }
    
    /* Cards */
    .card-img-top { 
      height: 200px; 
      object-fit: cover; 
      background: #e2e8f0; 
    }
    
    .description-text { 
      display: -webkit-box; 
      -webkit-line-clamp: 2; 
      -webkit-box-orient: vertical; 
      overflow: hidden; 
      font-size: 0.85rem; 
    }
    
    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #64748b;
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      .page-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .page-title {
        font-size: 1.25rem;
      }
      
      .btn-add {
        width: 100%;
      }
      
      .card-img-top { 
        height: 180px; 
      }
      
      .card-body {
        padding: 1rem;
      }
      
      .card-title {
        font-size: 1.1rem;
      }
      
      .badge {
        font-size: 0.75rem;
        padding: 0.4em 0.6em;
      }
      
      .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
      }
    }
    
    /* Status badge colors */
    .status-active { background: #10b981 !important; }
    .status-sold { background: #ef4444 !important; }
    .status-rented { background: #f59e0b !important; }
  </style>
</head>
<body>

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" data-bs-backdrop="static" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title">Admin Login</h5>
        </div>
        <div class="modal-body p-4">
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" class="form-control" id="email" placeholder="admin@spatio.com" />
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" class="form-control" id="password" placeholder="••••••••" />
          </div>
          <button class="btn btn-primary w-100" onclick="login()">Login</button>
          <div id="loginError" class="text-danger mt-2 small text-center"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Top Navigation -->
  <nav class="top-nav navbar navbar-expand-lg">
    <div class="container-fluid">
      <a class="navbar-brand nav-brand" href="#">
        <i class="fas fa-home"></i> Spatio Admin
      </a>
      
      <button class="mobile-menu-btn navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <i class="fas fa-bars"></i>
      </button>
      
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link active" href="#"><i class="fas fa-list me-1"></i> Listings</a>
          </li>
        </ul>
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link text-warning" href="#" onclick="logout()">
              <i class="fas fa-sign-out-alt me-1"></i> Logout
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div id="mainApp" style="display:none;">
    <div class="main-content">
      <div class="page-header">
        <h1 class="page-title">Property Management</h1>
        <button class="btn btn-primary btn-add" data-bs-toggle="modal" data-bs-target="#addModal">
          <i class="fas fa-plus"></i> Add New Listing
        </button>
      </div>

      <div class="row" id="listingsContainer">
        <!-- Listings will be populated here from Supabase -->
      </div>
    </div>
  </div>

  <!-- Add Property Modal -->
  <div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5>Add New Property</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="addForm">
            <div class="row g-3">
              <div class="col-md-6"><label>Location</label><input type="text" class="form-control" name="location" required></div>
              <div class="col-md-6"><label>Type</label><input type="text" class="form-control" name="type" placeholder="Apartment, Land..." required></div>
              <div class="col-md-6">
                <label>Category</label>
                <select class="form-select" name="category">
                  <option value="For Sale">For Sale</option>
                  <option value="To Let">To Let</option>
                </select>
              </div>
              <div class="col-md-6"><label>Price</label><input type="text" class="form-control" name="price" placeholder="KES 5,000,000" required></div>
              <div class="col-md-6"><label>Size</label><input type="text" class="form-control" name="size" placeholder="e.g. 50x100 or 3BHK" required></div>
              <div class="col-md-6">
                <label>Status</label>
                <select class="form-select" name="status">
                  <option value="active">Active</option>
                  <option value="sold">Sold</option>
                  <option value="rented">Rented</option>
                </select>
              </div>
              <div class="col-12"><label>Description</label><textarea class="form-control" name="description" rows="3"></textarea></div>
              <div class="col-md-6">
                <label>Latitude</label>
                <input type="number" step="any" class="form-control" name="lat">
              </div>
              <div class="col-md-6">
                <label>Longitude</label>
                <input type="number" step="any" class="form-control" name="lng">
              </div>
              <div class="col-12">
                <label>Property Photo</label>
                <input type="file" class="form-control" id="photoInput" accept="image/*" required>
                <img id="previewImg" class="mt-2 rounded border" style="max-height:150px; display:none;">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="addListing()">Save Property</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Property Modal -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5>Edit Property</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editForm">
            <input type="hidden" name="id" id="editId">
            <div class="row g-3">
              <div class="col-md-6"><label>Location</label><input type="text" class="form-control" name="location" required></div>
              <div class="col-md-6"><label>Type</label><input type="text" class="form-control" name="type" required></div>
              <div class="col-md-6">
                <label>Category</label>
                <select class="form-select" name="category">
                  <option value="For Sale">For Sale</option>
                  <option value="To Let">To Let</option>
                </select>
              </div>
              <div class="col-md-6"><label>Price</label><input type="text" class="form-control" name="price" required></div>
              <div class="col-md-6"><label>Size</label><input type="text" class="form-control" name="size" required></div>
              <div class="col-md-6">
                <label>Status</label>
                <select class="form-select" name="status">
                  <option value="active">Active</option>
                  <option value="sold">Sold</option>
                  <option value="rented">Rented</option>
                </select>
              </div>
              <div class="col-12"><label>Description</label><textarea class="form-control" name="description" rows="3"></textarea></div>
              <div class="col-md-6">
                <label>Latitude</label>
                <input type="number" step="any" class="form-control" name="lat">
              </div>
              <div class="col-md-6">
                <label>Longitude</label>
                <input type="number" step="any" class="form-control" name="lng">
              </div>
              <div class="col-12">
                <label>Change Photo (Optional)</label>
                <input type="file" class="form-control" id="editPhotoInput" accept="image/*">
                <img id="editPreviewImg" class="mt-2 rounded border" style="max-height:150px; display:none;">
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="saveEditedListing()">Update Property</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // FIXED: Removed trailing spaces in Supabase config
    const supabaseUrl = 'https://mdtcckyejiwdzocklfmf.supabase.co';
    const supabaseAnonKey = 'sb_publishable_1O-a6s0K1KANqu3w0nwFmw_uETdLXxn';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseAnonKey);

    let currentEditId = null;

    // FIXED: Only sanitize lat/lng (the ONLY numeric fields in your DB)
    function sanitizeNumericFields(payload) {
      // ONLY lat and lng are numeric in your database
      ['lat', 'lng'].forEach(field => {
        if (payload.hasOwnProperty(field)) {
          const value = payload[field];
          
          // Convert empty strings to null for numeric fields
          if (value === '' || value === null || value === undefined) {
            payload[field] = null;
          } else {
            // Parse as float
            const num = parseFloat(value);
            payload[field] = isNaN(num) ? null : num;
          }
        }
      });
      
      return payload;
    }

    document.addEventListener('DOMContentLoaded', () => {
      setupImagePreview('photoInput', 'previewImg');
      setupImagePreview('editPhotoInput', 'editPreviewImg');
      checkAuth();
    });

    function setupImagePreview(inputId, imgId) {
      const input = document.getElementById(inputId);
      const img = document.getElementById(imgId);
      input.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (re) => { 
            img.src = re.target.result; 
            img.style.display = 'block'; 
          };
          reader.readAsDataURL(file);
        }
      });
    }

    async function checkAuth() {
      const { data: { session } } = await supabaseClient.auth.getSession();
      if (session) {
        document.getElementById('mainApp').style.display = 'block';
        loadListings();
      } else {
        new bootstrap.Modal(document.getElementById('loginModal')).show();
      }
    }

    async function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if (error) {
        document.getElementById('loginError').innerText = error.message;
      } else {
        location.reload();
      }
    }

    function logout() {
      supabaseClient.auth.signOut().then(() => location.reload());
    }

    async function loadListings() {
      const { data, error } = await supabaseClient.from('properties').select('*').order('created_at', { ascending: false });
      
      if (error) {
        console.error('Error loading listings:', error);
        document.getElementById('listingsContainer').innerHTML = `
          <div class="col-12">
            <div class="alert alert-danger">Failed to load properties: ${error.message}</div>
          </div>
        `;
        return;
      }
      
      const container = document.getElementById('listingsContainer');
      
      if (!data || data.length === 0) {
        container.innerHTML = `
          <div class="col-12">
            <div class="empty-state">
              <i class="fas fa-home"></i>
              <h5>No Properties Found</h5>
              <p>Add your first property listing using the button above</p>
            </div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = data.map(item => `
        <div class="col-12 col-md-6 col-lg-4 mb-4">
          <div class="card h-100 shadow-sm border-0">
            <img src="${item.photo_url}" class="card-img-top" alt="Property" crossorigin="anonymous" onerror="this.src='https://via.placeholder.com/600x400?text=No+Image'">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                 <span class="badge bg-primary mb-2">${item.category}</span>
                 <span class="badge status-${item.status} mb-2">${item.status.charAt(0).toUpperCase() + item.status.slice(1)}</span>
              </div>
              <h5 class="card-title mb-1">${item.location}</h5>
              <p class="text-muted small mb-2"><i class="fas fa-expand-arrows-alt me-1"></i>${item.size || 'N/A'} • ${item.type}</p>
              <h6 class="text-success fw-bold">${item.price}</h6>
              <p class="description-text text-muted">${item.description || 'No description provided.'}</p>
              <div class="d-flex gap-2 mt-3">
                <button class="btn btn-sm btn-outline-primary flex-grow-1" onclick="editListing('${item.id}')">Edit</button>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteListing('${item.id}')"><i class="fas fa-trash"></i></button>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function addListing() {
      const form = document.getElementById('addForm');
      const file = document.getElementById('photoInput').files[0];
      if (!file) {
        alert("Photo is required");
        return;
      }

      try {
        // Upload image
        const fileName = `${Date.now()}_${file.name}`;
        const { error: upError } = await supabaseClient.storage.from('property-photos').upload(fileName, file);
        if (upError) throw upError;

        // Get public URL
        const { data: urlData } = supabaseClient.storage.from('property-photos').getPublicUrl(fileName);
        const photo_url = urlData.publicUrl;

        // Prepare payload and sanitize ONLY lat/lng
        const formData = new FormData(form);
        let payload = Object.fromEntries(formData);
        payload = sanitizeNumericFields(payload); // Only lat/lng
        payload.photo_url = photo_url;
        
        const { error: dbError } = await supabaseClient.from('properties').insert([payload]);
        if (dbError) throw dbError;
        
        // Success
        bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
        form.reset();
        document.getElementById('previewImg').style.display = 'none';
        loadListings();
      } catch (error) {
        console.error('Error adding listing:', error);
        const errorMsg = error.message || error.error_description || JSON.stringify(error);
        alert(`Error: ${errorMsg}`);
      }
    }

    async function editListing(id) {
      try {
        const { data, error } = await supabaseClient.from('properties').select('*').eq('id', id).single();
        if (error) throw error;

        currentEditId = id;
        const form = document.getElementById('editForm');
        
        // Populate form fields (handle nulls safely)
        form.querySelector('[name="location"]').value = data.location || '';
        form.querySelector('[name="type"]').value = data.type || '';
        form.querySelector('[name="category"]').value = data.category || 'For Sale';
        form.querySelector('[name="price"]').value = data.price || '';
        form.querySelector('[name="size"]').value = data.size || '';
        form.querySelector('[name="status"]').value = data.status || 'active';
        form.querySelector('[name="description"]').value = data.description || '';
        form.querySelector('[name="lat"]').value = (data.lat !== null && data.lat !== undefined) ? data.lat : '';
        form.querySelector('[name="lng"]').value = (data.lng !== null && data.lng !== undefined) ? data.lng : '';
        
        // Set preview image
        const preview = document.getElementById('editPreviewImg');
        preview.src = data.photo_url || 'https://via.placeholder.com/150?text=No+Image';
        preview.style.display = 'block';
        
        new bootstrap.Modal(document.getElementById('editModal')).show();
      } catch (error) {
        console.error('Error loading property for edit:', error);
        const errorMsg = error.message || error.error_description || JSON.stringify(error);
        alert(`Error: ${errorMsg}`);
      }
    }

    async function saveEditedListing() {
      try {
        const form = document.getElementById('editForm');
        const file = document.getElementById('editPhotoInput').files[0];
        const formData = new FormData(form);
        let payload = Object.fromEntries(formData);
        
        console.log('Payload before sanitization:', JSON.stringify(payload, null, 2)); // DEBUG
        
        // CRITICAL FIX: Remove 'id' field from payload to prevent bigint error
        delete payload.id;
        
        console.log('Payload after removing id:', JSON.stringify(payload, null, 2)); // DEBUG
        
        // Sanitize ONLY lat/lng (the numeric fields)
        payload = sanitizeNumericFields(payload);
        
        console.log('Payload after sanitization:', JSON.stringify(payload, null, 2)); // DEBUG
        
        // Handle image upload if new file selected
        if (file) {
          const fileName = `${Date.now()}_${file.name}`;
          const { error: upError } = await supabaseClient.storage.from('property-photos').upload(fileName, file);
          if (upError) throw upError;
          
          const { data: urlData } = supabaseClient.storage.from('property-photos').getPublicUrl(fileName);
          payload.photo_url = urlData.publicUrl;
        }

        console.log('Final payload being sent:', JSON.stringify(payload, null, 2)); // DEBUG
        
        const { error } = await supabaseClient.from('properties').update(payload).eq('id', currentEditId);
        if (error) {
          console.error('Supabase update error:', error);
          throw error;
        }
        
        // Success
        bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
        loadListings();
      } catch (error) {
        console.error('Error updating listing:', error);
        const errorMsg = error.message || error.error_description || JSON.stringify(error);
        alert(`Update failed: ${errorMsg}`);
      }
    }

    async function deleteListing(id) {
      if (!confirm("Are you sure you want to delete this property?")) return;
      
      try {
        const { error } = await supabaseClient.from('properties').delete().eq('id', id);
        if (error) throw error;
        loadListings();
      } catch (error) {
        console.error('Error deleting listing:', error);
        const errorMsg = error.message || error.error_description || JSON.stringify(error);
        alert(`Error: ${errorMsg}`);
      }
    }
  </script>
</body>
</html>
